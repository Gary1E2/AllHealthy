#:kivy 2.0
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp

# ==============================
# ROUNDED BUTTON - FIXED VERSION
# ==============================
<RoundedButton@Button>:
    bg_color: (0.5, 0.5, 0.5, 1)
    background_normal: ""
    background_down: ""
    background_disabled_normal: ""
    background_disabled_down: ""
    background_color: 0, 0, 0, 0

    canvas.before:
        Color:
            rgba: self.bg_color if self.bg_color else (1, 1, 1, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(15)]

# ==============================
# CUSTOM SPINNER OPTION
# ==============================
<CustomSpinnerOption@SpinnerOption>:
    background_normal: ""
    background_down: ""
    background_color: 0, 0, 0, 0
    color: get_color_from_hex("#BFD1E5")
    font_size: dp(16)
    height: dp(44)
    
    canvas.before:
        Color:
            rgba: get_color_from_hex("#4A4A4A") if self.state == 'normal' else get_color_from_hex("#5A5A5A")
        Rectangle:
            pos: self.pos
            size: self.size

# ==============================
# CUSTOM SPINNER (ROUNDED)
# ==============================
<RoundedSpinner@Spinner>:
    background_normal: ""
    background_down: ""
    background_color: 0, 0, 0, 0
    option_cls: "CustomSpinnerOption"
    
    canvas.before:
        Color:
            rgba: get_color_from_hex("#B0CA87")
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(10)]

# ==============================
# GLOBAL STYLES
# ==============================
<Label>:
    color: get_color_from_hex("#BFD1E5")

<Button>:
    background_normal: ''

<TextInput>:
    background_color: 1, 1, 1, 0.1
    foreground_color: get_color_from_hex("#BFD1E5")
    cursor_color: get_color_from_hex("#BFD1E5")
    write_tab: False

# ==============================
# LOADING SCREEN
# ==============================
<LoadingScreen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex("#1E2D2F")
        Rectangle:
            pos: self.pos
            size: self.size
    
    BoxLayout:
        orientation: "vertical"
        spacing: dp(20)
        size_hint: 0.6, 0.4
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        
        Label:
            text: "Diet Tracker"
            font_size: dp(32)
            bold: True
            color: get_color_from_hex("#B0CA87")
            size_hint_y: 0.3
        
        Label:
            id: status_label
            text: "Initializing..."
            font_size: dp(18)
            color: get_color_from_hex("#BFD1E5")
            size_hint_y: 0.2
        
        ProgressBar:
            id: progress
            max: 100
            value: 0
            size_hint_y: 0.2
        
        Label:
            text: "Tip: First load may take 30-60 seconds"
            font_size: dp(14)
            color: get_color_from_hex("#808080")
            size_hint_y: 0.2

# ==============================
# CHAT BUBBLE
# ==============================
<ChatBubble>:
    size_hint_y: None
    
    BoxLayout:
        size_hint_y: None
        size_hint_x: 1
        padding: dp(15)
        canvas.before:
            Color:
                rgba: get_color_from_hex("#7D4E57") if root.is_user else get_color_from_hex("#809848")
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [dp(15)]
        
        Label:
            id: bubble_label
            text: root.text
            color: get_color_from_hex("#BFD1E5")
            halign: "left"
            valign: "top"
            size_hint: 1, None
            markup: True
            text_size: self.width, None
            height: self.texture_size[1] + dp(10)

# ==============================
# MACROS HEADER
# ==============================
<MacrosHeader>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(155)
    spacing: 0
    
    BoxLayout:
        id: header_container
        orientation: "horizontal"
        size_hint: 1, None
        height: dp(120)
        padding: dp(8)
        spacing: dp(8)
        canvas.before:
            Color:
                rgba: get_color_from_hex("#B0CA87")
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [dp(8)]
        
        # Left: Pie chart
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.45
            spacing: dp(3)
            
            Label:
                text: "Daily Calories"
                color: get_color_from_hex("#1E2D2F")
                font_size: dp(12)
                bold: True
                size_hint_y: 0.2
            
            FloatLayout:
                id: pie_container
                size_hint: 1, 0.8
        
        # Right: Progress bars
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.55
            spacing: dp(4)
            padding: dp(6), dp(3)
            
            Label:
                text: "Macros Progress"
                color: get_color_from_hex("#1E2D2F")
                font_size: dp(12)
                bold: True
                size_hint_y: 0.15
            
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(6)
                size_hint_y: 0.85
                
                MacroBar:
                    id: protein_bar
                    bar_label: "Proteins"
                    bar_color: "#FF6B6B"
                
                MacroBar:
                    id: carbs_bar
                    bar_label: "Carbs"
                    bar_color: "#4ECDC4"
                
                MacroBar:
                    id: fats_bar
                    bar_label: "Fats"
                    bar_color: "#FFE66D"
    
    RoundedButton:
        id: analytics_btn
        text: "Show Analytics"
        size_hint: 1, None
        height: dp(35)
        bg_color: get_color_from_hex("#B0CA87")
        color: get_color_from_hex("#1E2D2F")
        bold: True
        font_size: dp(11)

# ==============================
# MACRO BAR
# ==============================
<MacroBar@BoxLayout>:
    bar_label: "Macro"
    bar_color: "#FFFFFF"
    orientation: 'vertical'
    spacing: dp(1)
    
    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 0.5
        
        Label:
            text: root.bar_label
            color: get_color_from_hex("#1E2D2F")
            font_size: dp(11)
            bold: True
            halign: "left"
            size_hint_x: 0.5
            text_size: self.size
        
        Label:
            id: value_label
            text: "0/0g"
            color: get_color_from_hex("#1E2D2F")
            font_size: dp(10)
            halign: "right"
            size_hint_x: 0.5
            text_size: self.size
    
    BoxLayout:
        size_hint_y: None
        height: dp(6)
        canvas.before:
            Color:
                rgba: get_color_from_hex("#809848")
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [dp(3)]
        
        BoxLayout:
            id: bar
            canvas.before:
                Color:
                    rgba: get_color_from_hex(root.bar_color)
                RoundedRectangle:
                    pos: self.pos
                    size: 0, self.height
                    radius: [dp(3)]

# ==============================
# CHAT SCREEN
# ==============================
<ChatScreen>:
    orientation: "vertical"
    padding: dp(10)
    spacing: dp(10)
    
    MacrosHeader:
        id: macros_header
    
    ScrollView:
        id: scroll
        size_hint: 1, 0.75
        
        BoxLayout:
            id: chat_history
            orientation: "vertical"
            size_hint_y: None
            spacing: dp(10)
            padding: dp(10)
            height: self.minimum_height
    
    BoxLayout:
        size_hint: 1, None
        height: dp(60)
        spacing: dp(10)
        
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, 1
            spacing: dp(10)
            padding: dp(10), dp(5), dp(10), dp(10)
            
            TextInput:
                id: chat_input
                hint_text: "Ask me anything..."
                multiline: False
                size_hint_x: 0.8
                font_size: dp(16)
            
            RoundedButton:
                text: "Send"
                size_hint_x: 0.2
                bg_color: get_color_from_hex("#809848")
                color: get_color_from_hex("#BFD1E5")
                font_size: dp(16)
                on_release: root.send_chat(self)
        
        RoundedButton:
            text: "Log\nMeal"
            bg_color: get_color_from_hex("#809848")
            color: get_color_from_hex("#BFD1E5")
            size_hint: 0.2, 1
            bold: True
            font_size: dp(16)
            on_press: root.open_meal_screen(self)
            markup: True

# ==============================
# MEAL LOGGING SCREEN - FIXED
# ==============================
<MealLoggingScreen>:
    orientation: "vertical"
    padding: dp(15)
    spacing: dp(8)
    canvas.before:
        Color:
            rgba: get_color_from_hex("#1E2D2F")
        Rectangle:
            pos: self.pos
            size: self.size
    
    # Header
    BoxLayout:
        size_hint_y: None
        height: dp(40)
        spacing: dp(10)
        
        RoundedButton:
            text: "Back"
            size_hint_x: 0.2
            bg_color: get_color_from_hex("#7D4E57")
            color: get_color_from_hex("#BFD1E5")
            font_size: dp(16)
            on_press: root.go_back(self)
        
        Label:
            text: "Log Meal"
            font_size: dp(22)
            bold: True
            color: get_color_from_hex("#B0CA87")
            size_hint_x: 0.8
    
    # Meal type selector - NOW WITH BUTTONS
    BoxLayout:
        orientation: 'vertical'
        size_hint_y: None
        height: dp(95)
        spacing: dp(5)
        pos_hint: {'top': 1}
        
        Label:
            text: "Meal Type:"
            font_size: dp(14)
            bold: True
            size_hint_y: None
            height: dp(22)
            halign: 'left'
            text_size: self.size
        
        # First row of meal buttons
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(35)
            spacing: dp(5)
            
            RoundedButton:
                id: breakfast_btn
                text: "Breakfast"
                bg_color: get_color_from_hex("#4A5A4B")
                color: get_color_from_hex("#BFD1E5")
                font_size: dp(13)
                on_press: root.set_meal_type("breakfast")
            
            RoundedButton:
                id: lunch_btn
                text: "Lunch"
                bg_color: get_color_from_hex("#4A5A4B")
                color: get_color_from_hex("#BFD1E5")
                font_size: dp(13)
                on_press: root.set_meal_type("lunch")
            
            RoundedButton:
                id: dinner_btn
                text: "Dinner"
                bg_color: get_color_from_hex("#4A5A4B")
                color: get_color_from_hex("#BFD1E5")
                font_size: dp(13)
                on_press: root.set_meal_type("dinner")
        
        # Second row of meal buttons
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(35)
            spacing: dp(5)
            
            RoundedButton:
                id: supper_btn
                text: "Supper"
                bg_color: get_color_from_hex("#4A5A4B")
                color: get_color_from_hex("#BFD1E5")
                font_size: dp(13)
                on_press: root.set_meal_type("supper")
            
            RoundedButton:
                id: snacks_btn
                text: "Snacks"
                bg_color: get_color_from_hex("#4A5A4B")
                color: get_color_from_hex("#BFD1E5")
                font_size: dp(13)
                on_press: root.set_meal_type("snacks")
            
            # Empty widget to balance layout
            Widget:
    
    # Image section
    BoxLayout:
        orientation: 'vertical'
        size_hint_y: None
        height: dp(140)
        spacing: dp(5)
        pos_hint: {'top': 1}
        
        Label:
            text: "Meal Image:"
            font_size: dp(14)
            bold: True
            size_hint_y: None
            height: dp(22)
            halign: 'left'
            text_size: self.size
        
        FloatLayout:
            size_hint_y: None
            height: dp(100)
            canvas.before:
                Color:
                    rgba: 0.2, 0.2, 0.2, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(8)]
            
            Label:
                id: img_placeholder
                text: "No image selected"
                font_size: dp(12)
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                markup: True
                color: 0.6, 0.6, 0.6, 1
            
            Image:
                id: img_preview
                size_hint: None, None
                size: 0, 0
                allow_stretch: True
                keep_ratio: True
                opacity: 0
        
        Label:
            id: status_label
            text: "Upload an image to auto-estimate nutrition"
            size_hint_y: None
            height: dp(18)
            font_size: dp(11)
            color: get_color_from_hex("#B0CA87")
            halign: 'center'
            text_size: self.size
    
    BoxLayout:
        size_hint_y: None
        height: dp(40)
        spacing: dp(8)
        pos_hint: {'top': 1}
        
        RoundedButton:
            text: "Take Photo"
            bg_color: get_color_from_hex("#809848")
            color: get_color_from_hex("#BFD1E5")
            font_size: dp(14)
            bold: True
            on_press: root.take_photo(self)
        
        RoundedButton:
            text: "Upload Image"
            bg_color: get_color_from_hex("#B0CA87")
            color: get_color_from_hex("#1E2D2F")
            font_size: dp(14)
            bold: True
            on_press: root.upload_image(self)
    
    # Description input
    TextInputField:
        id: description_input
        field_label: "Description (optional)"
        pos_hint: {'top': 1}
    
    # Nutrition inputs - TWO COLUMNS
    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: None
        height: dp(120)
        spacing: dp(10)
        pos_hint: {'top': 1}
        
        # Left column: Calories and Proteins
        BoxLayout:
            orientation: 'vertical'
            spacing: dp(8)
            
            NutritionInput:
                id: calories_input
                field_label: "Calories"
            
            NutritionInput:
                id: proteins_input
                field_label: "Proteins"
        
        # Right column: Carbs and Fats
        BoxLayout:
            orientation: 'vertical'
            spacing: dp(8)
            
            NutritionInput:
                id: carbs_input
                field_label: "Carbs"
            
            NutritionInput:
                id: fats_input
                field_label: "Fats"
    
    # Log button (fixed at bottom)
    BoxLayout:
        size_hint_y: None
        height: dp(55)
        padding: 0, dp(5), 0, 0
        pos_hint: {'bottom': 1}
        
        RoundedButton:
            id: log_btn
            text: "Log Meal"
            size_hint_y: None
            height: dp(50)
            bg_color: get_color_from_hex("#809848")
            color: get_color_from_hex("#BFD1E5")
            font_size: dp(17)
            bold: True
            on_press: root.log_meal(self)

# ==============================
# NUTRITION INPUT FIELD - COMPACT
# ==============================
<NutritionInput@BoxLayout>:
    field_label: "Field"
    orientation: 'vertical'
    size_hint_y: None
    height: dp(56)
    spacing: dp(3)
    
    Label:
        text: root.field_label + ":"
        size_hint_y: None
        height: dp(20)
        font_size: dp(13)
        bold: True
        halign: 'left'
        text_size: self.size
    
    TextInput:
        id: input_field
        hint_text: f"Enter {root.field_label.lower()}"
        multiline: False
        input_filter: 'float'
        size_hint_y: None
        height: dp(33)
        font_size: dp(15)
        padding: dp(8), dp(8)
        write_tab: False
        keyboard_suggestions: False
        focus_behavior: True

# ==============================
# TEXT INPUT FIELD - COMPACT
# ==============================
<TextInputField@BoxLayout>:
    field_label: "Field"
    orientation: 'vertical'
    size_hint_y: None
    height: dp(70)
    spacing: dp(3)
    
    Label:
        text: root.field_label + ":"
        size_hint_y: None
        height: dp(20)
        font_size: dp(13)
        bold: True
        halign: 'left'
        text_size: self.size

    TextInput:
        id: text_input
        hint_text: f"Enter {root.field_label.lower()}"
        multiline: True
        size_hint_y: None
        height: dp(47)
        font_size: dp(15)
        padding: dp(8), dp(8)
        background_color: 0.15, 0.15, 0.15, 1
        foreground_color: 1, 1, 1, 1
        cursor_color: 0.2, 0.6, 1, 1
        write_tab: False
        keyboard_suggestions: False
        focus_behavior: True
        
# ==============================
# MEAL SURVEY POPUP
# ==============================
<MealSurveyPopup>:
    title: "Rate Your Current State"
    size_hint: 0.9, 0.7
    auto_dismiss: False
    
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        
        Label:
            text: "Energy Level (1=Very Low, 5=Very High)"
            size_hint_y: 0.15
            bold: True
        
        BoxLayout:
            id: energy_layout
            orientation: 'horizontal'
            spacing: dp(10)
            size_hint_y: 0.2
        
        Label:
            text: "Hunger Level (1=Not Hungry, 5=Very Hungry)"
            size_hint_y: 0.15
            bold: True
        
        BoxLayout:
            id: hunger_layout
            orientation: 'horizontal'
            spacing: dp(10)
            size_hint_y: 0.2
        
        RoundedButton:
            text: "Submit"
            size_hint_y: 0.2
            bg_color: get_color_from_hex("#809848")
            font_size: '18sp'
            bold: True
            on_release: root.submit(self)

# ==============================
# LINE GRAPH
# ==============================
<LineGraph>:
    size_hint: 1, None
    height: dp(220)
    canvas.before:
        Color:
            rgba: get_color_from_hex("#B0CA87")
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(8)]
    
    Label:
        id: title_label
        text: root.title
        color: get_color_from_hex("#1E2D2F")
        font_size: dp(13)
        bold: True
        size_hint: 1, None
        height: dp(25)
        pos_hint: {'top': 1}

# ==============================
# ANALYTICS POPUP
# ==============================
<AnalyticsPopup>:
    title: "7-Day Analytics"
    size_hint: 0.95, 0.85
    
    BoxLayout:
        orientation: 'vertical'
        spacing: dp(10)
        padding: dp(10)
        
        ScrollView:
            size_hint: 1, 1
            do_scroll_x: False
            bar_width: dp(8)
            
            BoxLayout:
                id: graphs_container
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(15)
                padding: dp(5), dp(5)
        
        RoundedButton:
            text: "Close"
            size_hint: 1, None
            height: dp(50)
            bg_color: get_color_from_hex("#7D4E57")
            color: get_color_from_hex("#BFD1E5")
            font_size: dp(16)
            bold: True
            on_press: root.dismiss()